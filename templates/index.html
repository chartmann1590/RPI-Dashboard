<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .devices-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .devices-table th,
        .devices-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .devices-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #667eea;
        }
        
        .devices-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-home {
            background-color: #4caf50;
        }
        
        .status-away {
            background-color: #f44336;
        }
        
        .device-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        .device-link:hover {
            text-decoration: underline;
        }
        
        .weather-widget {
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
        
        .weather-main {
            text-align: center;
        }
        
        .weather-temp {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .weather-desc {
            font-size: 1.2rem;
            color: #666;
            text-transform: capitalize;
        }
        
        .weather-details {
            display: grid;
            gap: 0.5rem;
        }
        
        .weather-detail {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        /* Forecast styles */
        .forecast-container {
            margin-top: 1.5rem;
        }
        
        .forecast-section {
            margin-bottom: 1.5rem;
        }
        
        .forecast-section h3 {
            font-size: 1.2rem;
            color: #667eea;
            margin-bottom: 1rem;
        }
        
        .hourly-forecast {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .hourly-item {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        
        .hourly-item:hover {
            background-color: #e9ecef;
        }
        
        .hourly-time {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .hourly-temp {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
        }
        
        .hourly-desc {
            font-size: 0.9rem;
            color: #666;
        }
        
        .daily-forecast {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .daily-item {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        
        .daily-item:hover {
            background-color: #e9ecef;
        }
        
        .daily-day {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .daily-temps {
            font-size: 1.2rem;
            margin-bottom: 0.3rem;
        }
        
        .daily-high {
            font-weight: bold;
        }
        
        .daily-desc {
            font-size: 0.9rem;
            color: #666;
        }
        
        .news-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .news-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }
        
        .news-item:hover {
            background-color: #f8f9fa;
        }
        
        .news-item:last-child {
            border-bottom: none;
        }
        
        .news-source {
            color: #667eea;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }
        
        .news-title {
            font-weight: 600;
            margin-bottom: 0.3rem;
        }
        
        .news-desc {
            color: #666;
            font-size: 0.9rem;
        }
        
        .joke-current {
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .joke-updated {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }
        
        .joke-history-item {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }
        
        .joke-history-item:hover {
            background-color: #f8f9fa;
        }
        
        .joke-history-item:last-child {
            border-bottom: none;
        }
        
        .joke-history-text {
            margin-bottom: 0.3rem;
            line-height: 1.5;
        }
        
        .joke-history-timestamp {
            color: #666;
            font-size: 0.85rem;
        }
        
        .quote-history-item {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }
        
        .quote-history-item:hover {
            background-color: #f8f9fa;
        }
        
        .quote-history-item:last-child {
            border-bottom: none;
        }
        
        .quote-history-text {
            margin-bottom: 0.3rem;
            line-height: 1.5;
            font-style: italic;
        }
        
        .quote-history-author {
            color: #667eea;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.3rem;
        }
        
        .quote-history-timestamp {
            color: #666;
            font-size: 0.85rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.3s ease;
        }
        
        .btn-primary {
            background-color: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #5a5dcf;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 2rem;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        
        /* Make forecast card full width */
        .forecast-card {
            grid-column: 1 / -1;
        }
        
        /* ==================== HOME ASSISTANT STYLES ==================== */
        .ha-section {
            margin-bottom: 2rem;
        }
        
        .ha-section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .ha-section-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .ha-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        
        .ha-section-count {
            margin-left: auto;
            background: #e9ecef;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }
        
        .ha-domain-group {
            margin-bottom: 1.5rem;
        }
        
        .ha-domain-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: #667eea;
            text-transform: capitalize;
        }
        
        .ha-domain-icon {
            font-size: 1rem;
        }
        
        .ha-devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.75rem;
        }
        
        .ha-device-card {
            background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 100%);
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            cursor: default;
        }
        
        .ha-device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }
        
        .ha-device-card.device-on {
            background: linear-gradient(145deg, #e8f5e9 0%, #f1f8e9 100%);
            border-color: #a5d6a7;
        }
        
        .ha-device-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            background: #e9ecef;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        
        .ha-device-card.device-on .ha-device-icon {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
        }
        
        .ha-device-info {
            flex: 1;
            min-width: 0;
        }
        
        .ha-device-name {
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .ha-device-entity {
            font-size: 0.75rem;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .ha-device-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .ha-status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
            transition: all 0.3s ease;
        }
        
        .ha-status-indicator.status-on {
            background: #4caf50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
            animation: pulse-green 2s infinite;
        }
        
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 8px rgba(76, 175, 80, 0.6); }
            50% { box-shadow: 0 0 12px rgba(76, 175, 80, 0.8); }
        }
        
        .ha-status-text {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .ha-status-text.status-on {
            color: #4caf50;
        }
        
        .ha-status-text.status-off {
            color: #999;
        }
        
        /* Battery styles */
        .ha-battery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 0.75rem;
        }
        
        .ha-battery-card {
            background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 100%);
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .ha-battery-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .ha-battery-card.battery-low {
            background: linear-gradient(145deg, #ffebee 0%, #fff3e0 100%);
            border-color: #ffcdd2;
        }
        
        .ha-battery-card.battery-medium {
            background: linear-gradient(145deg, #fff8e1 0%, #fffde7 100%);
            border-color: #ffe082;
        }
        
        .ha-battery-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .ha-battery-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
        }
        
        .ha-battery-percent {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .ha-battery-percent.level-high { color: #4caf50; }
        .ha-battery-percent.level-medium { color: #ff9800; }
        .ha-battery-percent.level-low { color: #f44336; }
        
        .ha-battery-bar-container {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .ha-battery-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease, background 0.3s ease;
        }
        
        .ha-battery-bar.level-high {
            background: linear-gradient(90deg, #4caf50 0%, #66bb6a 100%);
        }
        
        .ha-battery-bar.level-medium {
            background: linear-gradient(90deg, #ff9800 0%, #ffb74d 100%);
        }
        
        .ha-battery-bar.level-low {
            background: linear-gradient(90deg, #f44336 0%, #e57373 100%);
            animation: pulse-bar 1.5s infinite;
        }
        
        @keyframes pulse-bar {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .ha-battery-entity {
            font-size: 0.7rem;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .ha-empty-state {
            text-align: center;
            padding: 2rem;
            color: #999;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #e9ecef;
        }
        
        .ha-empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            opacity: 0.5;
        }
        
        .ha-empty-state-text {
            font-size: 0.95rem;
        }
        
        .ha-stats-bar {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            color: white;
        }
        
        .ha-stat-item {
            flex: 1;
            text-align: center;
        }
        
        .ha-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.25rem;
        }
        
        .ha-stat-label {
            font-size: 0.75rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .ha-stat-divider {
            width: 1px;
            background: rgba(255, 255, 255, 0.3);
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            .weather-widget {
                flex-direction: column;
                gap: 1rem;
            }
            
            .hourly-forecast,
            .daily-forecast {
                grid-template-columns: 1fr;
            }
            
            /* Home Assistant responsive styles */
            .ha-stats-bar {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .ha-stat-item {
                flex: 1 1 40%;
                padding: 0.5rem;
            }
            
            .ha-stat-divider {
                display: none;
            }
            
            .ha-devices-grid,
            .ha-battery-grid {
                grid-template-columns: 1fr;
            }
            
            .ha-device-card {
                padding: 0.75rem;
            }
            
            .ha-device-icon {
                width: 38px;
                height: 38px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>üè† Home Dashboard</h1>
        <p>Real-time home monitoring and information</p>
    </header>
    
    <div class="container">
        <div class="dashboard-grid">
            <!-- Who's Home Card -->
            <div class="card">
                <h2>üë• Who's Home</h2>
                <table class="devices-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Last Seen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in devices %}
                        <tr>
                            <td>
                                <a href="{{ url_for('device_history', name=device[0]) }}" class="device-link">
                                    {{ device[0] }}
                                </a>
                            </td>
                            <td>
                                <span class="status-indicator status-{{ device[1] }}"></span>
                                {{ device[1] | capitalize }}
                            </td>
                            <td>{{ device[2] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Weather Card -->
            <div class="card">
                <h2>üå§Ô∏è Current Weather</h2>
                <div id="weather-widget" class="loading">
                    Loading weather data...
                </div>
            </div>
            
            <!-- News Card -->
            <div class="card">
                <h2>üì∞ Latest News</h2>
                <div id="news-widget" class="loading">
                    Loading news...
                </div>
            </div>
            
            <!-- Joke Card -->
            <div class="card">
                <h2>üòÑ Daily Joke</h2>
                <div id="joke-widget" class="loading">
                    Loading joke...
                </div>
                <div id="joke-history" style="margin-top: 1.5rem; display: none;">
                    <h3 style="font-size: 1.2rem; color: #667eea; margin-bottom: 1rem;">Joke History (Last 100)</h3>
                    <div id="joke-history-list" style="max-height: 400px; overflow-y: auto;"></div>
                    <div id="joke-history-pagination" style="margin-top: 1rem; display: flex; justify-content: center; align-items: center; gap: 1rem; display: none;">
                        <button id="joke-prev-btn" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Previous</button>
                        <span id="joke-page-info" style="color: #666;"></span>
                        <button id="joke-next-btn" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Next</button>
                    </div>
                </div>
            </div>
            
            <!-- Weather Forecast Card (Full Width) -->
            <div class="card forecast-card">
                <h2>üìÖ Weather Forecast</h2>
                <div id="forecast-widget" class="loading">
                    Loading forecast...
                </div>
            </div>
            
            <!-- Weather Alerts Card -->
            <div class="card">
                <h2>‚ö†Ô∏è Weather Alerts</h2>
                <div id="weather-alerts-widget" class="loading">
                    Loading weather alerts...
                </div>
            </div>
            
            <!-- Calendar Card -->
            <div class="card">
                <h2>üìÖ Calendar Events</h2>
                <div id="calendar-widget" class="loading">
                    Loading calendar events...
                </div>
            </div>
            
            <!-- Calendar Management Card -->
            <div class="card forecast-card">
                <h2>‚öôÔ∏è Calendar Management</h2>
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.2rem; color: #667eea; margin-bottom: 1rem;">Add iCal Feed</h3>
                    <form id="add-feed-form" style="display: grid; gap: 1rem; grid-template-columns: 1fr 2fr auto;">
                        <input type="text" id="feed-name" placeholder="Feed Name (optional)" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        <input type="text" id="feed-url" placeholder="iCal Feed URL" required style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        <button type="submit" class="btn btn-primary" style="padding: 0.5rem 1rem;">Add Feed</button>
                    </form>
                    <div id="feeds-list" style="margin-top: 1rem;"></div>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.2rem; color: #667eea; margin-bottom: 1rem;">Add Local Event</h3>
                    <form id="add-event-form" style="display: grid; gap: 1rem;">
                        <input type="text" id="event-title" placeholder="Event Title" required style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <input type="datetime-local" id="event-start" required style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                            <input type="datetime-local" id="event-end" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <input type="text" id="event-location" placeholder="Location (optional)" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        <textarea id="event-description" placeholder="Description (optional)" rows="3" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                        <button type="submit" class="btn btn-primary">Add Event</button>
                    </form>
                </div>
                <div>
                    <h3 style="font-size: 1.2rem; color: #667eea; margin-bottom: 1rem;">Local Events</h3>
                    <div id="local-events-list"></div>
                </div>
            </div>
            
            <!-- Commute Card -->
            <div class="card">
                <h2>üöó Commute</h2>
                <div id="commute-config" style="margin-bottom: 1rem;">
                    <form id="commute-form" style="display: grid; gap: 0.5rem;">
                        <input type="text" id="commute-origin" placeholder="Origin Address" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        <input type="text" id="commute-destination" placeholder="Destination Address" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        <button type="submit" class="btn btn-primary" style="padding: 0.5rem;">Save</button>
                    </form>
                </div>
                <div id="commute-widget" class="loading">
                    Loading commute info...
                </div>
                <div id="commute-map" style="height: 400px; width: 100%; margin-top: 1rem; border-radius: 8px; display: none;"></div>
                <div id="traffic-history" style="margin-top: 1.5rem; display: none;">
                    <h3 style="font-size: 1.2rem; color: #667eea; margin-bottom: 1rem;">Traffic Event History</h3>
                    <div id="traffic-history-list" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
            
            <!-- Air Quality Card -->
            <div class="card">
                <h2>üå¨Ô∏è Air Quality</h2>
                <div id="air-quality-widget" class="loading">
                    Loading air quality data...
                </div>
            </div>
            
            <!-- Quotes Card -->
            <div class="card">
                <h2>üí≠ Daily Quote</h2>
                <div id="quote-widget" class="loading">
                    Loading quote...
                </div>
                <div id="quote-history" style="margin-top: 1.5rem; display: none;">
                    <h3 style="font-size: 1.2rem; color: #667eea; margin-bottom: 1rem;">Quote History (Last 100)</h3>
                    <div id="quote-history-list" style="max-height: 400px; overflow-y: auto;"></div>
                    <div id="quote-history-pagination" style="margin-top: 1rem; display: flex; justify-content: center; align-items: center; gap: 1rem; display: none;">
                        <button id="quote-prev-btn" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Previous</button>
                        <span id="quote-page-info" style="color: #666;"></span>
                        <button id="quote-next-btn" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Next</button>
                    </div>
                </div>
            </div>
            
            <!-- Astronomy Card -->
            <div class="card">
                <h2>üåô Moon & Sun</h2>
                <div id="astronomy-widget" class="loading">
                    Loading astronomy data...
                </div>
            </div>
            
            <!-- Internet Speed Card -->
            <div class="card">
                <h2>‚ö° Internet Speed</h2>
                <div id="speed-widget" class="loading">
                    Loading speed test data...
                </div>
                <button id="run-speed-test" class="btn btn-secondary" style="margin-top: 1rem; width: 100%;">Run Speed Test</button>
            </div>
            
            <!-- Sports Card -->
            <div class="card">
                <h2>‚öΩ Sports Scores</h2>
                <div id="sports-config" style="margin-bottom: 1rem;">
                    <h3 style="font-size: 1.2rem; color: #667eea; margin-bottom: 1rem;">Manage Teams</h3>
                    <form id="sports-form" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 0.5rem; margin-bottom: 1rem;">
                        <input type="text" id="sports-team-input" placeholder="Enter team name" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        <select id="sports-sport-select" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="Basketball">Basketball (NBA)</option>
                            <option value="American Football">American Football (NFL)</option>
                            <option value="Baseball">Baseball (MLB)</option>
                            <option value="Ice Hockey">Ice Hockey (NHL)</option>
                            <option value="Soccer">Soccer</option>
                        </select>
                        <button type="submit" class="btn btn-primary" style="padding: 0.5rem 1rem;">Add Team</button>
                    </form>
                    <div id="sports-teams-list" style="margin-top: 1rem;">
                        <div style="text-align: center; color: #666; padding: 1rem;">Loading teams...</div>
                    </div>
                </div>
                <div id="sports-widget" class="loading">
                    Loading sports scores...
                </div>
            </div>
            
            <!-- Photo Gallery Card -->
            <div class="card forecast-card">
                <h2>üì∏ Photo Gallery</h2>
                <div id="photo-upload" style="margin-bottom: 1.5rem; padding: 1rem; border: 2px dashed #ddd; border-radius: 8px; text-align: center;">
                    <input type="file" id="photo-input" accept="image/*" multiple style="display: none;">
                    <button onclick="document.getElementById('photo-input').click()" class="btn btn-primary" style="margin-bottom: 0.5rem;">Choose Photos</button>
                    <p style="color: #666; font-size: 0.9rem;">or drag and drop photos here</p>
                    <div id="upload-progress" style="margin-top: 1rem; display: none;"></div>
                </div>
                <div id="photo-gallery" class="loading">
                    Loading photos...
                </div>
            </div>
            
            <!-- Package Tracking Card -->
            <div class="card forecast-card">
                <h2>üì¶ Package Tracking</h2>
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.2rem; color: #667eea; margin-bottom: 1rem;">Add Package</h3>
                    <form id="add-package-form" style="display: grid; gap: 0.5rem;">
                        <input type="text" id="package-tracking" placeholder="Tracking Number" required style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        <input type="text" id="package-description" placeholder="Description (optional)" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                        <button type="submit" class="btn btn-primary" style="padding: 0.5rem;">Add Package</button>
                    </form>
                </div>
                <div id="packages-widget" class="loading">
                    Loading packages...
                </div>
                <div id="packages-archive" style="margin-top: 2rem; display: none;">
                    <h3 style="font-size: 1.2rem; color: #667eea; margin-bottom: 1rem;">Archived Packages</h3>
                    <div id="packages-archive-list" style="max-height: 400px; overflow-y: auto;"></div>
                    <div id="packages-archive-pagination" style="margin-top: 1rem; display: flex; justify-content: center; align-items: center; gap: 1rem; display: none;">
                        <button id="archive-prev-btn" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Previous</button>
                        <span id="archive-page-info" style="color: #666;"></span>
                        <button id="archive-next-btn" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Next</button>
                    </div>
                </div>
            </div>
            
            <!-- Home Assistant Card -->
            <div class="card forecast-card">
                <h2>üè† Home Assistant</h2>
                <div id="ha-widget" class="loading">
                    Loading Home Assistant data...
                </div>
            </div>
        </div>
        
        <div class="action-buttons">
            <a href="/admin" class="btn btn-primary">Admin Panel</a>
            <a href="/rpi-dashboard" class="btn btn-secondary">RPi Dashboard</a>
        </div>
    </div>
    
    <script>
        // Fetch and display weather and news data
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard-data');
                const data = await response.json();
                
                // Update weather
                if (data.weather) {
                    const weatherWidget = document.getElementById('weather-widget');
                    weatherWidget.innerHTML = `
                        <div class="weather-widget">
                            <div class="weather-main">
                                <div class="weather-temp">${data.weather.temp}¬∞F</div>
                                <div class="weather-desc">${data.weather.description}</div>
                            </div>
                            <div class="weather-details">
                                <div class="weather-detail">
                                    <span>Feels Like</span>
                                    <span>${data.weather.feels_like}¬∞F</span>
                                </div>
                                <div class="weather-detail">
                                    <span>Humidity</span>
                                    <span>${data.weather.humidity}%</span>
                                </div>
                                <div class="weather-detail">
                                    <span>Wind</span>
                                    <span>${data.weather.wind_speed} mph</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('weather-widget').innerHTML = '<div class="error">Weather data unavailable</div>';
                }
                
                // Update forecast
                if (data.forecast) {
                    const forecastWidget = document.getElementById('forecast-widget');
                    let forecastHTML = '<div class="forecast-container">';
                    
                    // Hourly forecast
                    if (data.forecast.hourly && data.forecast.hourly.length > 0) {
                        forecastHTML += `
                            <div class="forecast-section">
                                <h3>Hourly Forecast</h3>
                                <div class="hourly-forecast">
                        `;
                        
                        data.forecast.hourly.forEach(hour => {
                            forecastHTML += `
                                <div class="hourly-item">
                                    <div class="hourly-time">${hour.time}</div>
                                    <div class="hourly-temp">${hour.temp}¬∞F</div>
                                    <div class="hourly-desc">${hour.description}</div>
                                </div>
                            `;
                        });
                        
                        forecastHTML += '</div></div>';
                    }
                    
                    // Daily forecast
                    if (data.forecast.daily && data.forecast.daily.length > 0) {
                        forecastHTML += `
                            <div class="forecast-section">
                                <h3>3-Day Forecast</h3>
                                <div class="daily-forecast">
                        `;
                        
                        data.forecast.daily.forEach(day => {
                            forecastHTML += `
                                <div class="daily-item">
                                    <div class="daily-day">${day.day}</div>
                                    <div class="daily-temps">
                                        <span class="daily-high">${day.high}¬∞</span> / ${day.low}¬∞
                                    </div>
                                    <div class="daily-desc">${day.description}</div>
                                </div>
                            `;
                        });
                        
                        forecastHTML += '</div></div>';
                    }
                    
                    forecastHTML += '</div>';
                    forecastWidget.innerHTML = forecastHTML;
                } else {
                    document.getElementById('forecast-widget').innerHTML = '<div class="error">Forecast data unavailable</div>';
                }
                
                // Update news
                if (data.news && data.news.length > 0) {
                    const newsWidget = document.getElementById('news-widget');
                    
                    // Get the news type from the first article (they should all be the same type)
                    const newsType = data.news[0].news_type || 'News';
                    
                    // Update the news header to show what type of news we're displaying
                    const newsHeader = document.querySelector('.card h2');
                    if (newsHeader && newsHeader.textContent.includes('News')) {
                        newsHeader.innerHTML = `üì∞ ${newsType}`;
                    }
                    
                    newsWidget.innerHTML = '<div class="news-list">' + 
                        data.news.map(article => `
                            <div class="news-item">
                                <div class="news-source">${article.source}</div>
                                <div class="news-title">${article.title}</div>
                                ${article.description ? `<div class="news-desc">${article.description}</div>` : ''}
                            </div>
                        `).join('') + '</div>';
                } else {
                    document.getElementById('news-widget').innerHTML = '<div class="error">News data unavailable</div>';
                }
                
                // Update joke
                if (data.joke) {
                    const jokeWidget = document.getElementById('joke-widget');
                    jokeWidget.innerHTML = `
                        <div class="joke-current">
                            ${data.joke.text || 'No joke available'}
                            <div class="joke-updated">Updated: ${data.joke.updated || ''}</div>
                        </div>
                    `;
                } else {
                    document.getElementById('joke-widget').innerHTML = '<div class="error">Joke data unavailable</div>';
                }
                
                // Load joke history
                loadJokeHistory();
                
                // Update weather alerts
                if (data.weather_alerts && data.weather_alerts.length > 0) {
                    const alertsWidget = document.getElementById('weather-alerts-widget');
                    alertsWidget.innerHTML = '<div class="news-list">' + 
                        data.weather_alerts.map(alert => {
                            const severityColor = alert.severity === 'Extreme' ? '#f44336' : 
                                                 alert.severity === 'Severe' ? '#ff9800' : 
                                                 alert.severity === 'Moderate' ? '#ffc107' : '#2196F3';
                            return `
                                <div class="news-item" style="border-left: 4px solid ${severityColor};">
                                    <div class="news-source" style="color: ${severityColor};">${alert.severity} - ${alert.type}</div>
                                    <div class="news-title">${alert.headline || 'Weather Alert'}</div>
                                    <div class="news-desc">${alert.area || ''}</div>
                                    <div class="news-desc" style="margin-top: 0.5rem;">${alert.description.substring(0, 300)}${alert.description.length > 300 ? '...' : ''}</div>
                                </div>
                            `;
                        }).join('') + '</div>';
                } else {
                    document.getElementById('weather-alerts-widget').innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No weather alerts</div>';
                }
                
                // Update packages
                if (data.packages && data.packages.length > 0) {
                    const packagesWidget = document.getElementById('packages-widget');
                    packagesWidget.innerHTML = '<div class="news-list">' + 
                        data.packages.map(pkg => {
                            const statusColor = pkg.status === 'Delivered' ? '#4caf50' : 
                                               pkg.status === 'Error' ? '#f44336' : '#2196F3';
                            return `
                                <div class="news-item">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                        <div>
                                            <div class="news-source">${pkg.carrier} - ${pkg.tracking_number}</div>
                                            <div class="news-title">${pkg.description || 'Package'}</div>
                                        </div>
                                        <div>
                                            <button onclick="refreshPackage(${pkg.id})" class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.9rem; margin-right: 0.5rem;">Refresh</button>
                                            <button onclick="deletePackage(${pkg.id})" class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.9rem;">Delete</button>
                                        </div>
                                    </div>
                                    <div class="news-desc">
                                        <strong style="color: ${statusColor};">Status:</strong> ${pkg.status}
                                        ${pkg.last_location ? ` ‚Ä¢ ${pkg.last_location}` : ''}
                                        ${pkg.estimated_delivery ? ` ‚Ä¢ ETA: ${pkg.estimated_delivery}` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('') + '</div>';
                } else {
                    document.getElementById('packages-widget').innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No packages being tracked</div>';
                }
                
                // Load archived packages
                loadPackagesArchive();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('weather-widget').innerHTML = '<div class="error">Failed to load weather data</div>';
                document.getElementById('forecast-widget').innerHTML = '<div class="error">Failed to load forecast data</div>';
                document.getElementById('news-widget').innerHTML = '<div class="error">Failed to load news data</div>';
                document.getElementById('joke-widget').innerHTML = '<div class="error">Failed to load joke data</div>';
            }
        }
        
        // Joke history pagination state
        let jokeHistoryPage = 1;
        const jokeHistoryPerPage = 5;
        
        // Load joke history with pagination
        async function loadJokeHistory(page = 1) {
            try {
                const response = await fetch(`/api/joke-history?page=${page}&per_page=${jokeHistoryPerPage}`);
                const data = await response.json();
                
                const historyDiv = document.getElementById('joke-history');
                const historyList = document.getElementById('joke-history-list');
                const paginationDiv = document.getElementById('joke-history-pagination');
                const pageInfo = document.getElementById('joke-page-info');
                const prevBtn = document.getElementById('joke-prev-btn');
                const nextBtn = document.getElementById('joke-next-btn');
                
                if (data.jokes && data.jokes.length > 0) {
                    historyDiv.style.display = 'block';
                    historyList.innerHTML = data.jokes.map(joke => `
                        <div class="joke-history-item">
                            <div class="joke-history-text">${joke.text}</div>
                            <div class="joke-history-timestamp">${joke.timestamp}</div>
                        </div>
                    `).join('');
                    
                    // Update pagination controls
                    if (data.total_pages > 1) {
                        paginationDiv.style.display = 'flex';
                        pageInfo.textContent = `Page ${data.page} of ${data.total_pages} (${data.total_count} total)`;
                        prevBtn.disabled = !data.has_prev;
                        nextBtn.disabled = !data.has_next;
                        jokeHistoryPage = data.page;
                        setupJokePagination();
                    } else {
                        paginationDiv.style.display = 'none';
                    }
                } else if (data.total_count > 0) {
                    // No jokes on this page but there are jokes
                    historyDiv.style.display = 'block';
                    historyList.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No jokes on this page</div>';
                    paginationDiv.style.display = 'flex';
                    pageInfo.textContent = `Page ${data.page} of ${data.total_pages}`;
                    prevBtn.disabled = !data.has_prev;
                    nextBtn.disabled = !data.has_next;
                    jokeHistoryPage = data.page;
                    setupJokePagination();
                } else {
                    historyDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading joke history:', error);
            }
        }
        
        // Joke history pagination event handlers (set up after DOM is ready)
        function setupJokePagination() {
            const jokePrevBtn = document.getElementById('joke-prev-btn');
            const jokeNextBtn = document.getElementById('joke-next-btn');
            
            if (jokePrevBtn && !jokePrevBtn.hasAttribute('data-listener-added')) {
                jokePrevBtn.setAttribute('data-listener-added', 'true');
                jokePrevBtn.addEventListener('click', () => {
                    if (jokeHistoryPage > 1) {
                        loadJokeHistory(jokeHistoryPage - 1);
                    }
                });
            }
            
            if (jokeNextBtn && !jokeNextBtn.hasAttribute('data-listener-added')) {
                jokeNextBtn.setAttribute('data-listener-added', 'true');
                jokeNextBtn.addEventListener('click', () => {
                    loadJokeHistory(jokeHistoryPage + 1);
                });
            }
        }
        
        // ==================== CALENDAR FUNCTIONS ====================
        async function loadCalendarEvents() {
            try {
                const response = await fetch('/api/calendar-events');
                const events = await response.json();
                
                const widget = document.getElementById('calendar-widget');
                if (events && events.length > 0) {
                    widget.innerHTML = '<div class="news-list">' + 
                        events.slice(0, 5).map(event => `
                            <div class="news-item">
                                <div class="news-source">${event.source}</div>
                                <div class="news-title">${event.title}</div>
                                <div class="news-desc">${event.date} at ${event.time}${event.location ? ' ‚Ä¢ ' + event.location : ''}</div>
                            </div>
                        `).join('') + '</div>';
                } else {
                    widget.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No upcoming events</div>';
                }
            } catch (error) {
                console.error('Error loading calendar events:', error);
                document.getElementById('calendar-widget').innerHTML = '<div class="error">Failed to load calendar events</div>';
            }
        }
        
        async function loadCalendarFeeds() {
            try {
                const response = await fetch('/api/calendar-feeds');
                const feeds = await response.json();
                
                const list = document.getElementById('feeds-list');
                if (feeds && feeds.length > 0) {
                    list.innerHTML = '<h4 style="margin-bottom: 0.5rem;">Existing Feeds:</h4>' +
                        feeds.map(feed => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f8f9fa; border-radius: 5px; margin-bottom: 0.5rem;">
                                <span><strong>${feed.name || 'Unnamed'}</strong>: ${feed.url.substring(0, 50)}...</span>
                                <button onclick="deleteFeed(${feed.id})" class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.9rem;">Delete</button>
                            </div>
                        `).join('');
                } else {
                    list.innerHTML = '<p style="color: #666;">No calendar feeds added yet.</p>';
                }
            } catch (error) {
                console.error('Error loading feeds:', error);
            }
        }
        
        async function deleteFeed(feedId) {
            if (!confirm('Delete this calendar feed?')) return;
            try {
                const response = await fetch(`/api/calendar-feeds/${feedId}`, { method: 'DELETE' });
                if (response.ok) {
                    loadCalendarFeeds();
                    loadCalendarEvents();
                }
            } catch (error) {
                console.error('Error deleting feed:', error);
                alert('Error deleting feed');
            }
        }
        
        async function loadLocalEvents() {
            try {
                const response = await fetch('/api/calendar-events/local');
                const events = await response.json();
                
                const list = document.getElementById('local-events-list');
                if (events && events.length > 0) {
                    list.innerHTML = events.map(event => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 5px; margin-bottom: 0.5rem;">
                            <div>
                                <strong>${event.title}</strong><br>
                                <small style="color: #666;">${event.start_time}${event.location ? ' ‚Ä¢ ' + event.location : ''}</small>
                            </div>
                            <div>
                                <button onclick="editEvent(${event.id})" class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.9rem; margin-right: 0.5rem;">Edit</button>
                                <button onclick="deleteEvent(${event.id})" class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.9rem;">Delete</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<p style="color: #666;">No local events added yet.</p>';
                }
            } catch (error) {
                console.error('Error loading local events:', error);
            }
        }
        
        async function deleteEvent(eventId) {
            if (!confirm('Delete this event?')) return;
            try {
                const response = await fetch(`/api/calendar-events/local/${eventId}`, { method: 'DELETE' });
                if (response.ok) {
                    loadLocalEvents();
                    loadCalendarEvents();
                }
            } catch (error) {
                console.error('Error deleting event:', error);
                alert('Error deleting event');
            }
        }
        
        function editEvent(eventId) {
            // Simple edit - reload and populate form
            loadLocalEvents();
            alert('Edit functionality - populate form with event data');
        }
        
        // ==================== COMMUTE FUNCTIONS ====================
        let commuteMap = null;
        
        async function loadCommuteInfo() {
            try {
                const response = await fetch('/api/commute-info');
                const commute = await response.json();
                
                const widget = document.getElementById('commute-widget');
                const mapDiv = document.getElementById('commute-map');
                
                if (commute) {
                    // Display text info with traffic events
                    let trafficNotices = '';
                    if (commute.traffic_events && commute.traffic_events.length > 0) {
                        trafficNotices = '<div style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; max-height: 150px; overflow-y: auto; overflow-x: hidden;">';
                        commute.traffic_events.forEach(event => {
                            const levelColor = event.traffic_level === 'heavy' ? '#f44336' : event.traffic_level === 'medium' ? '#ffc107' : '#4caf50';
                            const levelText = event.traffic_level.charAt(0).toUpperCase() + event.traffic_level.slice(1);
                            const eventIcon = event.type === 'crash' ? 'üö®' : '‚ö†Ô∏è';
                            trafficNotices += `<div style="margin-bottom: 0.4rem; font-size: 0.85rem; line-height: 1.3;">
                                ${eventIcon} <strong style="color: ${levelColor};">${levelText} Traffic</strong> at ${event.location} - ${event.description} (${event.time})
                            </div>`;
                        });
                        trafficNotices += '</div>';
                    } else {
                        // Show light traffic when no issues
                        trafficNotices = '<div style="margin-top: 0.5rem; padding: 0.5rem; background: #d4edda; border-left: 4px solid #4caf50; border-radius: 4px; text-align: center;">';
                        trafficNotices += '<div style="font-size: 0.85rem; color: #155724;"><strong style="color: #4caf50;">‚úì Light Traffic</strong> - No traffic issues detected</div>';
                        trafficNotices += '</div>';
                    }
                    
                    widget.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #667eea; margin-bottom: 0.5rem;">${commute.duration_formatted}</div>
                            <div style="color: #666; margin-bottom: 0.5rem;">${commute.distance_miles} miles</div>
                            <div style="font-size: 0.9rem; color: #999;">${commute.origin} ‚Üí ${commute.destination}</div>
                            <div style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">Updated: ${commute.updated}</div>
                        </div>
                        <div style="margin-top: 0.5rem; text-align: center; font-size: 0.75rem; color: #999;">
                            <span style="color: #4caf50;">‚óè</span> Light Traffic &nbsp;
                            <span style="color: #ffc107;">‚óè</span> Medium Traffic &nbsp;
                            <span style="color: #f44336;">‚óè</span> Heavy Traffic
                        </div>
                        ${trafficNotices}
                    `;
                    
                    // Load traffic history
                    loadTrafficHistory();
                    
                    // Render map if route coordinates are available
                    if (commute.route_coordinates && commute.route_coordinates.length > 0) {
                        // Clear any existing map
                        if (commuteMap) {
                            commuteMap.remove();
                            commuteMap = null;
                        }
                        
                        // Show map container first
                        mapDiv.style.display = 'block';
                        
                        // Wait a bit to ensure map container is ready (fixes MutationObserver error)
                        setTimeout(() => {
                            try {
                                // Calculate bounds from route coordinates
                                const latLngs = commute.route_coordinates.map(coord => [coord[1], coord[0]]);
                                const bounds = L.latLngBounds(latLngs);
                                
                                // Create map - don't set view initially, let fitBounds handle it
                                commuteMap = L.map('commute-map', {
                                    zoomControl: true,
                                    preferCanvas: false
                                });
                                
                                // Add OpenStreetMap tiles
                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                    attribution: '¬© OpenStreetMap contributors',
                                    maxZoom: 19
                                }).addTo(commuteMap);
                                
                                // Add origin marker
                                L.marker([commute.origin_lat, commute.origin_lon])
                                    .addTo(commuteMap)
                                    .bindPopup(`Origin: ${commute.origin}`);
                                
                                // Add destination marker
                                L.marker([commute.dest_lat, commute.dest_lon])
                                    .addTo(commuteMap)
                                    .bindPopup(`Destination: ${commute.destination}`);
                                
                                // Draw route with color-coded segments - ONLY use colored segments
                                if (commute.route_segments && commute.route_segments.length > 0) {
                                    // Draw each segment with appropriate color based on traffic level
                                    commute.route_segments.forEach(segment => {
                                        if (segment.coordinates && segment.coordinates.length > 0) {
                                            // Determine color based on traffic level
                                            let color = '#4caf50'; // Green for light traffic (default)
                                            if (segment.traffic_level === 'medium') {
                                                color = '#ffc107'; // Yellow for medium traffic
                                            } else if (segment.traffic_level === 'heavy') {
                                                color = '#f44336'; // Red for heavy traffic
                                            }
                                            
                                            // Convert coordinates from [lon, lat] to [lat, lon] for Leaflet
                                            const segmentLatLngs = segment.coordinates.map(coord => [coord[1], coord[0]]);
                                            
                                            // Draw the segment with the traffic color
                                            L.polyline(segmentLatLngs, {
                                                color: color,
                                                weight: 6,
                                                opacity: 0.9
                                            }).addTo(commuteMap);
                                        }
                                    });
                                } else {
                                    // If no segments, divide route into equal parts and show as light traffic (green)
                                    // This should rarely happen, but ensures we always show something
                                    const numSegments = Math.max(1, Math.floor(latLngs.length / 10));
                                    const segmentSize = Math.floor(latLngs.length / numSegments);
                                    for (let i = 0; i < latLngs.length; i += segmentSize) {
                                        const segment = latLngs.slice(i, i + segmentSize);
                                        if (segment.length > 1) {
                                            L.polyline(segment, {
                                                color: '#4caf50', // Green for light traffic
                                                weight: 6,
                                                opacity: 0.9
                                            }).addTo(commuteMap);
                                        }
                                    }
                                }
                                
                                // Fit map bounds to show entire route with padding - this will set the zoom
                                commuteMap.fitBounds(bounds, {
                                    padding: [30, 30],
                                    maxZoom: 15
                                });
                            } catch (error) {
                                console.error('Error rendering commute map:', error);
                                mapDiv.style.display = 'none';
                            }
                        }, 200);
                    } else {
                        mapDiv.style.display = 'none';
                    }
                } else {
                    widget.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">Configure commute route above</div>';
                    mapDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading commute info:', error);
                document.getElementById('commute-widget').innerHTML = '<div class="error">Failed to load commute info</div>';
                document.getElementById('commute-map').style.display = 'none';
            }
        }
        
        // Load traffic history
        async function loadTrafficHistory() {
            try {
                const response = await fetch('/api/traffic-history');
                const data = await response.json();
                
                const historyDiv = document.getElementById('traffic-history');
                const historyList = document.getElementById('traffic-history-list');
                
                if (data.events && data.events.length > 0) {
                    historyDiv.style.display = 'block';
                    historyList.innerHTML = data.events.map(event => {
                        const levelColor = event.traffic_level === 'heavy' ? '#f44336' : event.traffic_level === 'medium' ? '#ffc107' : '#4caf50';
                        const levelText = event.traffic_level.charAt(0).toUpperCase() + event.traffic_level.slice(1);
                        const eventIcon = event.type === 'crash' ? 'üö®' : event.type === 'heavy_traffic' ? '‚ö†Ô∏è' : 'üìä';
                        return `
                            <div style="padding: 0.75rem; border-bottom: 1px solid #eee; transition: background-color 0.3s ease;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='transparent'">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.3rem;">
                                    <div>
                                        <strong style="color: ${levelColor};">${eventIcon} ${levelText} Traffic</strong>
                                        ${event.type === 'crash' ? '<span style="color: #f44336; font-weight: bold;"> - CRASH DETECTED</span>' : ''}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #666;">${event.date} ${event.time}</div>
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">${event.location}</div>
                                <div style="font-size: 0.85rem; color: #999;">${event.description}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    historyDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading traffic history:', error);
            }
        }
        
        // ==================== AIR QUALITY FUNCTIONS ====================
        async function loadAirQuality() {
            try {
                const response = await fetch('/api/air-quality');
                const aq = await response.json();
                
                const widget = document.getElementById('air-quality-widget');
                if (aq) {
                    widget.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; font-weight: bold; color: ${aq.color}; margin-bottom: 0.5rem;">${aq.aqi}</div>
                            <div style="font-size: 1.2rem; margin-bottom: 1rem;">${aq.level}</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.9rem;">
                                <div>PM2.5: ${aq.pm25} ¬µg/m¬≥</div>
                                <div>PM10: ${aq.pm10} ¬µg/m¬≥</div>
                                <div>NO‚ÇÇ: ${aq.no2} ¬µg/m¬≥</div>
                                <div>O‚ÇÉ: ${aq.o3} ¬µg/m¬≥</div>
                            </div>
                            <div style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">Updated: ${aq.updated}</div>
                        </div>
                    `;
                } else {
                    widget.innerHTML = '<div class="error">Air quality data unavailable</div>';
                }
            } catch (error) {
                console.error('Error loading air quality:', error);
                document.getElementById('air-quality-widget').innerHTML = '<div class="error">Failed to load air quality</div>';
            }
        }
        
        // ==================== QUOTES FUNCTIONS ====================
        // Quote history pagination state
        let quoteHistoryPage = 1;
        const quoteHistoryPerPage = 5;
        
        async function loadQuote() {
            try {
                const response = await fetch('/api/daily-quote');
                const quote = await response.json();
                
                const widget = document.getElementById('quote-widget');
                if (quote) {
                    widget.innerHTML = `
                        <div style="padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">
                            <div style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 0.5rem;">"${quote.text}"</div>
                            <div style="text-align: right; font-style: italic;">‚Äî ${quote.author}</div>
                        </div>
                    `;
                } else {
                    widget.innerHTML = '<div class="error">Quote unavailable</div>';
                }
                
                // Load quote history
                loadQuoteHistory();
            } catch (error) {
                console.error('Error loading quote:', error);
                document.getElementById('quote-widget').innerHTML = '<div class="error">Failed to load quote</div>';
            }
        }
        
        // Load quote history with pagination
        async function loadQuoteHistory(page = 1) {
            try {
                const response = await fetch(`/api/quote-history?page=${page}&per_page=${quoteHistoryPerPage}`);
                const data = await response.json();
                
                const historyDiv = document.getElementById('quote-history');
                const historyList = document.getElementById('quote-history-list');
                const paginationDiv = document.getElementById('quote-history-pagination');
                const pageInfo = document.getElementById('quote-page-info');
                const prevBtn = document.getElementById('quote-prev-btn');
                const nextBtn = document.getElementById('quote-next-btn');
                
                if (data.quotes && data.quotes.length > 0) {
                    historyDiv.style.display = 'block';
                    historyList.innerHTML = data.quotes.map(quote => `
                        <div class="quote-history-item">
                            <div class="quote-history-text">"${quote.text}"</div>
                            <div class="quote-history-author">‚Äî ${quote.author}</div>
                            <div class="quote-history-timestamp">${quote.timestamp}</div>
                        </div>
                    `).join('');
                    
                    // Update pagination controls
                    if (data.total_pages > 1) {
                        paginationDiv.style.display = 'flex';
                        pageInfo.textContent = `Page ${data.page} of ${data.total_pages} (${data.total_count} total)`;
                        prevBtn.disabled = !data.has_prev;
                        nextBtn.disabled = !data.has_next;
                        quoteHistoryPage = data.page;
                        setupQuotePagination();
                    } else {
                        paginationDiv.style.display = 'none';
                    }
                } else if (data.total_count > 0) {
                    // No quotes on this page but there are quotes
                    historyDiv.style.display = 'block';
                    historyList.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No quotes on this page</div>';
                    paginationDiv.style.display = 'flex';
                    pageInfo.textContent = `Page ${data.page} of ${data.total_pages}`;
                    prevBtn.disabled = !data.has_prev;
                    nextBtn.disabled = !data.has_next;
                    quoteHistoryPage = data.page;
                } else {
                    historyDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading quote history:', error);
            }
        }
        
        // Quote history pagination event handlers (set up after DOM is ready)
        function setupQuotePagination() {
            const quotePrevBtn = document.getElementById('quote-prev-btn');
            const quoteNextBtn = document.getElementById('quote-next-btn');
            
            if (quotePrevBtn && !quotePrevBtn.hasAttribute('data-listener-added')) {
                quotePrevBtn.setAttribute('data-listener-added', 'true');
                quotePrevBtn.addEventListener('click', () => {
                    if (quoteHistoryPage > 1) {
                        loadQuoteHistory(quoteHistoryPage - 1);
                    }
                });
            }
            
            if (quoteNextBtn && !quoteNextBtn.hasAttribute('data-listener-added')) {
                quoteNextBtn.setAttribute('data-listener-added', 'true');
                quoteNextBtn.addEventListener('click', () => {
                    loadQuoteHistory(quoteHistoryPage + 1);
                });
            }
        }
        
        // ==================== ASTRONOMY FUNCTIONS ====================
        async function loadAstronomy() {
            try {
                const response = await fetch('/api/astronomy');
                const astro = await response.json();
                
                const widget = document.getElementById('astronomy-widget');
                if (astro) {
                    widget.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 0.5rem;">${astro.moon_icon}</div>
                            <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem;">${astro.moon_phase_name}</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div>
                                    <div style="font-size: 0.9rem; color: #666;">Sunrise</div>
                                    <div style="font-size: 1.2rem; font-weight: bold;">${astro.sunrise}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9rem; color: #666;">Sunset</div>
                                    <div style="font-size: 1.2rem; font-weight: bold;">${astro.sunset}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    widget.innerHTML = '<div class="error">Astronomy data unavailable</div>';
                }
            } catch (error) {
                console.error('Error loading astronomy:', error);
                document.getElementById('astronomy-widget').innerHTML = '<div class="error">Failed to load astronomy data</div>';
            }
        }
        
        // ==================== INTERNET SPEED FUNCTIONS ====================
        async function loadInternetSpeed() {
            try {
                const response = await fetch('/api/internet-speed');
                const speed = await response.json();
                
                const widget = document.getElementById('speed-widget');
                if (speed) {
                    widget.innerHTML = `
                        <div style="text-align: center;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <div style="font-size: 0.9rem; color: #666;">Download</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">${speed.download_mbps} Mbps</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9rem; color: #666;">Upload</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">${speed.upload_mbps} Mbps</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9rem; color: #666;">Ping</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">${speed.ping_ms} ms</div>
                                </div>
                            </div>
                            <div style="font-size: 0.8rem; color: #999;">Last test: ${speed.last_test}</div>
                        </div>
                    `;
                } else {
                    widget.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No speed test data. Click "Run Speed Test" to start.</div>';
                }
            } catch (error) {
                console.error('Error loading speed:', error);
                document.getElementById('speed-widget').innerHTML = '<div class="error">Failed to load speed data</div>';
            }
        }
        
        // ==================== SPORTS FUNCTIONS ====================
        async function loadSportsTeams() {
            try {
                const response = await fetch('/api/settings/sports');
                const data = await response.json();
                const teams = data.teams || [];
                
                const teamsList = document.getElementById('sports-teams-list');
                if (teams.length > 0) {
                    teamsList.innerHTML = '';
                    teams.forEach(team => {
                        // Handle both old format (string) and new format (object)
                        const teamName = typeof team === 'string' ? team : (team.name || team);
                        const teamSport = typeof team === 'object' ? (team.sport || 'Unknown') : 'Unknown';
                        
                        const teamDiv = document.createElement('div');
                        teamDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 5px; margin-bottom: 0.5rem;';
                        
                        const teamSpan = document.createElement('span');
                        teamSpan.style.fontWeight = '500';
                        teamSpan.textContent = `${teamName} (${teamSport})`;
                        teamDiv.appendChild(teamSpan);
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'btn btn-secondary';
                        removeBtn.style.cssText = 'padding: 0.25rem 0.75rem; font-size: 0.9rem;';
                        removeBtn.textContent = 'Remove';
                        removeBtn.onclick = () => removeTeam(teamName, teamSport);
                        teamDiv.appendChild(removeBtn);
                        
                        teamsList.appendChild(teamDiv);
                    });
                } else {
                    teamsList.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No teams added yet. Add a team above to get started.</div>';
                }
            } catch (error) {
                console.error('Error loading sports teams:', error);
                document.getElementById('sports-teams-list').innerHTML = '<div class="error">Failed to load teams</div>';
            }
        }
        
        async function removeTeam(teamName, teamSport) {
            if (!confirm(`Remove "${teamName}" from your teams?`)) return;
            
            try {
                const response = await fetch('/api/settings/sports');
                const data = await response.json();
                let teams = data.teams || [];
                
                // Remove the team (handle both old string format and new object format)
                teams = teams.filter(t => {
                    if (typeof t === 'string') {
                        return t !== teamName;
                    } else {
                        return t.name !== teamName || t.sport !== teamSport;
                    }
                });
                
                // Save updated teams
                const saveResponse = await fetch('/api/settings/sports', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ teams })
                });
                
                if (saveResponse.ok) {
                    loadSportsTeams();
                    loadSportsScores();
                } else {
                    alert('Error removing team');
                }
            } catch (error) {
                console.error('Error removing team:', error);
                alert('Error removing team');
            }
        }
        
        async function loadSportsScores() {
            try {
                const response = await fetch('/api/sports-scores');
                const scores = await response.json();
                
                const widget = document.getElementById('sports-widget');
                if (scores && scores.length > 0) {
                    widget.innerHTML = '<div class="news-list">' + 
                        scores.map(score => `
                            <div class="news-item">
                                <div class="news-source">${score.team}</div>
                                <div class="news-title">${score.event}</div>
                                <div class="news-desc">${score.status}${score.score ? ' ‚Ä¢ ' + score.score : ''}${score.date ? ' ‚Ä¢ ' + score.date : ''}</div>
                            </div>
                        `).join('') + '</div>';
                } else {
                    widget.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">Add teams above to see scores</div>';
                }
            } catch (error) {
                console.error('Error loading sports scores:', error);
                document.getElementById('sports-widget').innerHTML = '<div class="error">Failed to load sports scores</div>';
            }
        }
        
        // ==================== PHOTO GALLERY FUNCTIONS ====================
        async function loadPhotos() {
            try {
                const response = await fetch('/api/photos');
                const photos = await response.json();
                
                const gallery = document.getElementById('photo-gallery');
                if (photos && photos.length > 0) {
                    gallery.innerHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">' +
                        photos.map(photo => `
                            <div style="position: relative;">
                                <img src="${photo.url}" alt="${photo.filename}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer;" onclick="deletePhoto('${photo.filename}')">
                                <button onclick="deletePhoto('${photo.filename}')" class="btn btn-secondary" style="position: absolute; top: 5px; right: 5px; padding: 0.25rem 0.5rem; font-size: 0.8rem;">√ó</button>
                            </div>
                        `).join('') + '</div>';
                } else {
                    gallery.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No photos uploaded yet</div>';
                }
            } catch (error) {
                console.error('Error loading photos:', error);
                document.getElementById('photo-gallery').innerHTML = '<div class="error">Failed to load photos</div>';
            }
        }
        
        async function deletePhoto(filename) {
            if (!confirm('Delete this photo?')) return;
            try {
                const response = await fetch(`/api/delete-photo/${filename}`, { method: 'DELETE' });
                if (response.ok) {
                    loadPhotos();
                }
            } catch (error) {
                console.error('Error deleting photo:', error);
                alert('Error deleting photo');
            }
        }
        
        // ==================== FORM HANDLERS ====================
        document.getElementById('add-feed-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('feed-name').value;
            const url = document.getElementById('feed-url').value;
            
            try {
                const response = await fetch('/api/calendar-feeds', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, url })
                });
                if (response.ok) {
                    document.getElementById('feed-name').value = '';
                    document.getElementById('feed-url').value = '';
                    loadCalendarFeeds();
                    loadCalendarEvents();
                }
            } catch (error) {
                console.error('Error adding feed:', error);
                alert('Error adding feed');
            }
        });
        
        document.getElementById('add-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('event-title').value;
            const start_time = document.getElementById('event-start').value.replace('T', ' ') + ':00';
            const end_time = document.getElementById('event-end').value ? document.getElementById('event-end').value.replace('T', ' ') + ':00' : null;
            const location = document.getElementById('event-location').value;
            const description = document.getElementById('event-description').value;
            
            try {
                const response = await fetch('/api/calendar-events/local', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, start_time, end_time, location, description })
                });
                if (response.ok) {
                    document.getElementById('add-event-form').reset();
                    loadLocalEvents();
                    loadCalendarEvents();
                }
            } catch (error) {
                console.error('Error adding event:', error);
                alert('Error adding event');
            }
        });
        
        document.getElementById('commute-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const origin = document.getElementById('commute-origin').value;
            const destination = document.getElementById('commute-destination').value;
            
            try {
                const response = await fetch('/api/settings/commute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ origin, destination })
                });
                if (response.ok) {
                    loadCommuteInfo();
                }
            } catch (error) {
                console.error('Error saving commute:', error);
                alert('Error saving commute settings');
            }
        });
        
        document.getElementById('sports-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const teamInput = document.getElementById('sports-team-input');
            const sportSelect = document.getElementById('sports-sport-select');
            const newTeamName = teamInput.value.trim();
            const newTeamSport = sportSelect.value;
            
            if (!newTeamName) {
                alert('Please enter a team name');
                return;
            }
            
            try {
                // Get current teams
                const getResponse = await fetch('/api/settings/sports');
                const data = await getResponse.json();
                let teams = data.teams || [];
                
                // Normalize teams to object format for comparison
                const normalizedTeams = teams.map(t => {
                    if (typeof t === 'string') {
                        return { name: t, sport: 'Unknown' };
                    }
                    return t;
                });
                
                // Check if team already exists
                const teamExists = normalizedTeams.some(t => t.name.toLowerCase() === newTeamName.toLowerCase());
                if (teamExists) {
                    alert('This team is already in your list');
                    teamInput.value = '';
                    return;
                }
                
                // Add new team as object with name and sport
                teams.push({ name: newTeamName, sport: newTeamSport });
                
                // Save updated teams
                const saveResponse = await fetch('/api/settings/sports', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ teams })
                });
                
                if (saveResponse.ok) {
                    teamInput.value = '';
                    loadSportsTeams();
                    loadSportsScores();
                } else {
                    alert('Error adding team');
                }
            } catch (error) {
                console.error('Error adding team:', error);
                alert('Error adding team');
            }
        });
        
        document.getElementById('photo-input').addEventListener('change', async (e) => {
            const files = e.target.files;
            const progressDiv = document.getElementById('upload-progress');
            progressDiv.style.display = 'block';
            progressDiv.innerHTML = `Uploading ${files.length} photo(s)...`;
            
            for (let file of files) {
                const formData = new FormData();
                formData.append('photo', file);
                
                try {
                    const response = await fetch('/api/upload-photo', {
                        method: 'POST',
                        body: formData
                    });
                    if (!response.ok) throw new Error('Upload failed');
                } catch (error) {
                    console.error('Error uploading photo:', error);
                    alert(`Error uploading ${file.name}`);
                }
            }
            
            progressDiv.innerHTML = 'Upload complete!';
            setTimeout(() => {
                progressDiv.style.display = 'none';
                loadPhotos();
            }, 2000);
        });
        
        document.getElementById('run-speed-test').addEventListener('click', async () => {
            const btn = document.getElementById('run-speed-test');
            btn.disabled = true;
            btn.textContent = 'Running...';
            
            try {
                const response = await fetch('/api/internet-speed/run', { method: 'POST' });
                if (response.ok) {
                    setTimeout(() => {
                        loadInternetSpeed();
                        btn.disabled = false;
                        btn.textContent = 'Run Speed Test';
                    }, 30000); // Wait 30 seconds for test to complete
                }
            } catch (error) {
                console.error('Error starting speed test:', error);
                btn.disabled = false;
                btn.textContent = 'Run Speed Test';
            }
        });
        
        // ==================== PACKAGE TRACKING FUNCTIONS ====================
        let archivePage = 1;
        const archivePerPage = 5;
        
        async function loadPackagesArchive(page = 1) {
            try {
                const response = await fetch(`/api/packages/archive?page=${page}&per_page=${archivePerPage}`);
                const data = await response.json();
                
                const archiveDiv = document.getElementById('packages-archive');
                const archiveList = document.getElementById('packages-archive-list');
                const paginationDiv = document.getElementById('packages-archive-pagination');
                const pageInfo = document.getElementById('archive-page-info');
                const prevBtn = document.getElementById('archive-prev-btn');
                const nextBtn = document.getElementById('archive-next-btn');
                
                if (data.packages && data.packages.length > 0) {
                    archiveDiv.style.display = 'block';
                    archiveList.innerHTML = data.packages.map(pkg => `
                        <div class="news-item">
                            <div class="news-source">${pkg.carrier} - ${pkg.tracking_number}</div>
                            <div class="news-title">${pkg.description || 'Package'}</div>
                            <div class="news-desc">Status: ${pkg.status}${pkg.last_location ? ` ‚Ä¢ ${pkg.last_location}` : ''}</div>
                            <div class="news-desc" style="font-size: 0.85rem; color: #999;">Archived: ${pkg.archived_at}</div>
                        </div>
                    `).join('');
                    
                    if (data.total_pages > 1) {
                        paginationDiv.style.display = 'flex';
                        pageInfo.textContent = `Page ${data.page} of ${data.total_pages} (${data.total_count} total)`;
                        prevBtn.disabled = !data.has_prev;
                        nextBtn.disabled = !data.has_next;
                        archivePage = data.page;
                        setupArchivePagination();
                    } else {
                        paginationDiv.style.display = 'none';
                    }
                } else if (data.total_count > 0) {
                    archiveDiv.style.display = 'block';
                    archiveList.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No packages on this page</div>';
                    paginationDiv.style.display = 'flex';
                    pageInfo.textContent = `Page ${data.page} of ${data.total_pages}`;
                    prevBtn.disabled = !data.has_prev;
                    nextBtn.disabled = !data.has_next;
                    archivePage = data.page;
                    setupArchivePagination();
                } else {
                    archiveDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading archived packages:', error);
            }
        }
        
        function setupArchivePagination() {
            const prevBtn = document.getElementById('archive-prev-btn');
            const nextBtn = document.getElementById('archive-next-btn');
            
            if (prevBtn && !prevBtn.hasAttribute('data-listener-added')) {
                prevBtn.setAttribute('data-listener-added', 'true');
                prevBtn.addEventListener('click', () => {
                    if (archivePage > 1) {
                        loadPackagesArchive(archivePage - 1);
                    }
                });
            }
            
            if (nextBtn && !nextBtn.hasAttribute('data-listener-added')) {
                nextBtn.setAttribute('data-listener-added', 'true');
                nextBtn.addEventListener('click', () => {
                    loadPackagesArchive(archivePage + 1);
                });
            }
        }
        
        async function refreshPackage(packageId) {
            try {
                const response = await fetch(`/api/packages/${packageId}/refresh`, { method: 'POST' });
                if (response.ok) {
                    loadDashboardData();
                }
            } catch (error) {
                console.error('Error refreshing package:', error);
                alert('Error refreshing package');
            }
        }
        
        async function deletePackage(packageId) {
            if (!confirm('Delete this package?')) return;
            try {
                const response = await fetch(`/api/packages/${packageId}`, { method: 'DELETE' });
                if (response.ok) {
                    loadDashboardData();
                }
            } catch (error) {
                console.error('Error deleting package:', error);
                alert('Error deleting package');
            }
        }
        
        document.getElementById('add-package-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const tracking = document.getElementById('package-tracking').value.trim();
            const description = document.getElementById('package-description').value.trim();
            
            try {
                const response = await fetch('/api/packages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tracking_number: tracking, description: description })
                });
                if (response.ok) {
                    document.getElementById('add-package-form').reset();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    alert('Error adding package: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding package:', error);
                alert('Error adding package');
            }
        });
        
        // ==================== HOME ASSISTANT FUNCTIONS ====================
        // Domain icons mapping
        const domainIcons = {
            'light': 'üí°',
            'switch': 'üîå',
            'binary_sensor': 'üì°',
            'fan': 'üåÄ',
            'climate': 'üå°Ô∏è',
            'media_player': 'üì∫',
            'cover': 'ü™ü',
            'lock': 'üîê',
            'sensor': 'üìä',
            'other': '‚öôÔ∏è'
        };
        
        async function loadHomeAssistant() {
            try {
                const response = await fetch('/api/home-assistant');
                const data = await response.json();
                
                const widget = document.getElementById('ha-widget');
                if (!widget) return;
                
                if (data.error) {
                    widget.innerHTML = `<div class="error">Error loading Home Assistant data: ${data.error}</div>`;
                    return;
                }
                
                let html = '';
                
                // Group devices by domain
                const devicesByDomain = {};
                let totalDevices = 0;
                let devicesOn = 0;
                
                if (data.devices && data.devices.length > 0) {
                    data.devices.forEach(device => {
                        const entityId = device.entity_id || '';
                        const domain = entityId.split('.')[0] || 'other';
                        if (!devicesByDomain[domain]) {
                            devicesByDomain[domain] = [];
                        }
                        devicesByDomain[domain].push(device);
                        totalDevices++;
                        if (device.state?.toLowerCase() === 'on') devicesOn++;
                    });
                }
                
                // Count battery sensors
                const batteryCount = data.battery_sensors?.length || 0;
                const lowBatteryCount = data.battery_sensors?.filter(s => s.battery_level < 25).length || 0;
                
                // Stats bar
                if (totalDevices > 0 || batteryCount > 0) {
                    html += `
                        <div class="ha-stats-bar">
                            <div class="ha-stat-item">
                                <div class="ha-stat-value">${totalDevices}</div>
                                <div class="ha-stat-label">Total Devices</div>
                            </div>
                            <div class="ha-stat-divider"></div>
                            <div class="ha-stat-item">
                                <div class="ha-stat-value">${devicesOn}</div>
                                <div class="ha-stat-label">Currently On</div>
                            </div>
                            <div class="ha-stat-divider"></div>
                            <div class="ha-stat-item">
                                <div class="ha-stat-value">${batteryCount}</div>
                                <div class="ha-stat-label">Battery Sensors</div>
                            </div>
                            ${lowBatteryCount > 0 ? `
                                <div class="ha-stat-divider"></div>
                                <div class="ha-stat-item">
                                    <div class="ha-stat-value" style="color: #ffcdd2;">${lowBatteryCount}</div>
                                    <div class="ha-stat-label">Low Battery</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Display devices grouped by domain
                if (Object.keys(devicesByDomain).length > 0) {
                    html += '<div class="ha-section">';
                    html += `
                        <div class="ha-section-header">
                            <div class="ha-section-icon">‚ö°</div>
                            <h3 class="ha-section-title">Devices</h3>
                            <span class="ha-section-count">${totalDevices} devices</span>
                        </div>
                    `;
                    
                    // Sort domains with priority for common ones
                    const domainOrder = ['switch', 'light', 'fan', 'climate', 'media_player', 'cover', 'lock', 'binary_sensor'];
                    const sortedDomains = Object.keys(devicesByDomain).sort((a, b) => {
                        const aIndex = domainOrder.indexOf(a);
                        const bIndex = domainOrder.indexOf(b);
                        if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
                        if (aIndex === -1) return 1;
                        if (bIndex === -1) return -1;
                        return aIndex - bIndex;
                    });
                    
                    sortedDomains.forEach(domain => {
                        const domainDevices = devicesByDomain[domain];
                        const icon = domainIcons[domain] || domainIcons['other'];
                        
                        html += `<div class="ha-domain-group">`;
                        html += `<div class="ha-domain-header">
                            <span class="ha-domain-icon">${icon}</span>
                            <span>${domain.replace('_', ' ')}</span>
                        </div>`;
                        html += '<div class="ha-devices-grid">';
                        
                        domainDevices.forEach(device => {
                            const friendlyName = device.attributes?.friendly_name || device.entity_id;
                            const state = device.state || 'unknown';
                            const isOn = state.toLowerCase() === 'on';
                            
                            html += `
                                <div class="ha-device-card ${isOn ? 'device-on' : ''}">
                                    <div class="ha-device-icon">${icon}</div>
                                    <div class="ha-device-info">
                                        <div class="ha-device-name">${friendlyName}</div>
                                        <div class="ha-device-entity">${device.entity_id}</div>
                                    </div>
                                    <div class="ha-device-status">
                                        <span class="ha-status-indicator ${isOn ? 'status-on' : ''}"></span>
                                        <span class="ha-status-text ${isOn ? 'status-on' : 'status-off'}">${state}</span>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div></div>';
                    });
                    
                    html += '</div>';
                } else {
                    html += `
                        <div class="ha-empty-state">
                            <div class="ha-empty-state-icon">üè†</div>
                            <div class="ha-empty-state-text">No devices found</div>
                        </div>
                    `;
                }
                
                // Display battery sensors
                if (data.battery_sensors && data.battery_sensors.length > 0) {
                    html += '<div class="ha-section">';
                    html += `
                        <div class="ha-section-header">
                            <div class="ha-section-icon">üîã</div>
                            <h3 class="ha-section-title">Battery Sensors</h3>
                            <span class="ha-section-count">${batteryCount} sensors</span>
                        </div>
                    `;
                    html += '<div class="ha-battery-grid">';
                    
                    // Sort by battery level (lowest first)
                    const sortedBatteries = [...data.battery_sensors].sort((a, b) => 
                        (a.battery_level || 0) - (b.battery_level || 0)
                    );
                    
                    sortedBatteries.forEach(sensor => {
                        const friendlyName = sensor.attributes?.friendly_name || sensor.entity_id;
                        const batteryLevel = sensor.battery_level || 0;
                        const levelClass = batteryLevel < 25 ? 'level-low' : batteryLevel < 50 ? 'level-medium' : 'level-high';
                        const cardClass = batteryLevel < 25 ? 'battery-low' : batteryLevel < 50 ? 'battery-medium' : '';
                        
                        html += `
                            <div class="ha-battery-card ${cardClass}">
                                <div class="ha-battery-header">
                                    <div class="ha-battery-name">${friendlyName}</div>
                                    <div class="ha-battery-percent ${levelClass}">${batteryLevel}%</div>
                                </div>
                                <div class="ha-battery-bar-container">
                                    <div class="ha-battery-bar ${levelClass}" style="width: ${batteryLevel}%;"></div>
                                </div>
                                <div class="ha-battery-entity">${sensor.entity_id}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }
                
                if (html === '') {
                    html = `
                        <div class="ha-empty-state">
                            <div class="ha-empty-state-icon">üè†</div>
                            <div class="ha-empty-state-text">No Home Assistant data available.<br>Check your configuration.</div>
                        </div>
                    `;
                }
                
                widget.innerHTML = html;
            } catch (error) {
                console.error('Error loading Home Assistant data:', error);
                document.getElementById('ha-widget').innerHTML = `
                    <div class="ha-empty-state">
                        <div class="ha-empty-state-icon">‚ùå</div>
                        <div class="ha-empty-state-text">Failed to load Home Assistant data</div>
                    </div>
                `;
            }
        }
        
        // Load all data on page load
        loadDashboardData();
        loadCalendarEvents();
        loadCalendarFeeds();
        loadLocalEvents();
        loadCommuteInfo();
        loadAirQuality();
        loadQuote();
        loadAstronomy();
        loadInternetSpeed();
        loadSportsTeams();
        loadSportsScores();
        loadPhotos();
        loadHomeAssistant();
        
        // Refresh data every 5 minutes
        setInterval(() => {
            loadDashboardData();
            loadCalendarEvents();
            loadCommuteInfo();
            loadAirQuality();
            loadQuote();
            loadAstronomy();
            loadInternetSpeed();
            loadSportsScores();
            loadTrafficHistory();
            loadHomeAssistant();
        }, 300000);
        
        // Auto-refresh page every 60 seconds for device status
        setTimeout(() => {
            location.reload();
        }, 60000);
    </script>
</body>
</html>